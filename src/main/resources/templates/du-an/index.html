<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{fragments/layout :: layout(title=~{::title}, content=~{::main}, scripts=~{::scripts})}">

<head>
    <title th:fragment="title">Quản lý dự án</title>
</head>
<body>

<main th:fragment="main">
    <!-- Header Section with Gradient Background -->
    <div class="project-header py-4 mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="display-5 fw-bold text-white mb-2">Dự án của bạn</h1>
                    <p class="text-white-50 mb-0">Quản lý và theo dõi các dự án IoT</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <button type="button" class="btn btn-light btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#themDuAnModal">
                        <i class="bi bi-plus-lg me-2"></i>Thêm dự án mới
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container pb-5">
        <!-- Empty State -->
        <div th:if="${#lists.isEmpty(duAns)}" class="text-center py-5 empty-state-container">
            <div class="empty-state-content">
                <div class="mb-4">
                    <i class="bi bi-building-add display-1"></i>
                </div>
                <h2 class="fw-bold mb-3">Bắt đầu hành trình IoT của bạn</h2>
                <p class="text-muted mb-4">Tạo dự án đầu tiên và bắt đầu quản lý thiết bị IoT của bạn ngay hôm nay</p>
                <button type="button" class="btn btn-gradient btn-lg" data-bs-toggle="modal" data-bs-target="#themDuAnModal">
                    <i class="bi bi-plus-lg me-2"></i>Tạo dự án đầu tiên
                </button>
            </div>
        </div>

        <!-- Project List -->
        <div class="row g-4" th:unless="${#lists.isEmpty(duAns)}">
            <div class="col-md-4" th:each="duAn : ${duAns}">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="card-title fw-bold mb-0" th:text="${duAn.tenDuAn}">Tên dự án</h4>
                            <div class="dropdown">
                                <button class="btn btn-link text-dark p-0" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal"
                                           data-bs-target="#chinhSuaDuAnModal"
                                           th:data-id="${duAn.maDuAn}"
                                           th:data-ten="${duAn.tenDuAn}"
                                           th:data-mota="${duAn.moTa}">
                                            <i class="bi bi-pencil me-2"></i>Chỉnh sửa
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" 
                                           th:onclick="'return xoaDuAn(' + ${duAn.maDuAn} + ')'">
                                            <i class="bi bi-trash me-2"></i>Xóa
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <p class="card-text text-muted mb-4" th:text="${duAn.moTa}">Mô tả dự án</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <a th:href="@{/du-an/{id}/khu-vuc(id=${duAn.maDuAn})}" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-diagram-3 me-2"></i>Xem khu vực
                            </a>
                            <div>
                                <span class="badge bg-light text-primary me-2">
                                    <i class="bi bi-diagram-3 me-1"></i>
                                    <span th:text="${#lists.size(duAn.khuVucs)}">0</span> khu vực
                                </span>
                                <span class="badge bg-light text-primary">
                                    <i class="bi bi-cpu me-1"></i>
                                    <span th:text="${#aggregates.sum(duAn.khuVucs.![thietBis.size()])}">0</span> thiết bị
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Thêm Dự Án -->
    <div class="modal fade" id="themDuAnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm dự án mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="themDuAnForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="tenDuAn" class="form-label">Tên dự án<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="tenDuAn" required>
                        </div>
                        <div class="mb-3">
                            <label for="moTa" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="moTa" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="btnTaoDuAn">Tạo dự án</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Chỉnh Sửa Dự Án -->
    <div class="modal fade" id="chinhSuaDuAnModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa dự án</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="chinhSuaDuAnForm">
                    <div class="modal-body">
                        <input type="hidden" id="maDuAnEdit">
                        <div class="mb-3">
                            <label for="tenDuAnEdit" class="form-label">Tên dự án<span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="tenDuAnEdit" required>
                        </div>
                        <div class="mb-3">
                            <label for="moTaEdit" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="moTaEdit" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="btnLuuDuAn">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<th:block th:fragment="scripts">
    <script th:inline="javascript">
        // CSS styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            .project-header {
                background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            }
            .btn-gradient {
                background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
                color: white;
            }
            .shadow-hover {
                transition: all 0.3s ease;
            }
            .shadow-hover:hover {
                box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
            }
            .empty-state-container {
                background-color: #fff;
                border-radius: .375rem;
                box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
            }
        `;
        document.head.appendChild(styleSheet);

        // Initialize modals
        const themDuAnModal = new bootstrap.Modal(document.getElementById('themDuAnModal'));
        const chinhSuaDuAnModal = new bootstrap.Modal(document.getElementById('chinhSuaDuAnModal'));

        // Form handling for create
        document.getElementById('themDuAnForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnTaoDuAn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';

            try {
                const formData = {
                    tenDuAn: document.getElementById('tenDuAn').value,
                    moTa: document.getElementById('moTa').value
                };

                const response = await fetch('/du-an/them-moi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [document.querySelector('meta[name="_csrf_header"]').content]: 
                        document.querySelector('meta[name="_csrf"]').content
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    throw new Error(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                alert(error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Form handling for edit
        document.getElementById('chinhSuaDuAnForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnLuuDuAn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...';

            try {
                const maDuAn = document.getElementById('maDuAnEdit').value;
                const formData = {
                    tenDuAn: document.getElementById('tenDuAnEdit').value,
                    moTa: document.getElementById('moTaEdit').value
                };

                const response = await fetch(`/du-an/${maDuAn}/cap-nhat`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [document.querySelector('meta[name="_csrf_header"]').content]: 
                        document.querySelector('meta[name="_csrf"]').content
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    throw new Error(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                alert(error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Handle edit modal data population
        document.getElementById('chinhSuaDuAnModal').addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const maDuAn = button.getAttribute('data-id');
            const tenDuAn = button.getAttribute('data-ten');
            const moTa = button.getAttribute('data-mota');

            document.getElementById('maDuAnEdit').value = maDuAn;
            document.getElementById('tenDuAnEdit').value = tenDuAn;
            document.getElementById('moTaEdit').value = moTa;
        });

        // Delete project handler
        async function xoaDuAn(maDuAn) {
            if (!confirm('Bạn có chắc chắn muốn xóa dự án này?')) {
                return false;
            }

            try {
                const response = await fetch(`/du-an/${maDuAn}/xoa`, {
                    method: 'DELETE',
                    headers: {
                        [document.querySelector('meta[name="_csrf_header"]').content]: 
                        document.querySelector('meta[name="_csrf"]').content
                    }
                });

                const data = await response.json();
                if (data.success) {
                    location.reload();
                } else {
                    throw new Error(data.message || 'Có lỗi xảy ra');
                }
            } catch (error) {
                alert('Có lỗi xảy ra khi xóa: ' + error.message);
                return false;
            }
        }

        // Ensure modals are direct children of <body> to avoid stacking context issues
        // Some layouts or parent containers may create stacking contexts (transform/overflow)
        // Move all .modal elements to document.body on DOMContentLoaded so Bootstrap backdrops
        // and modals render and receive pointer events correctly.
        document.addEventListener('DOMContentLoaded', function () {
            try {
                document.querySelectorAll('.modal').forEach(function(modalEl) {
                    if (modalEl && modalEl.parentElement !== document.body) {
                        document.body.appendChild(modalEl);
                    }
                });
            } catch (e) {
                // silence any errors to avoid breaking page scripts
                console.error('Error moving modals to body:', e);
            }
        });

        // Ensure any modal that opens gets z-index higher than other page floating elements
        // and that the backdrop sits just below it.
        document.addEventListener('show.bs.modal', function (e) {
            try {
                const modalEl = e.target;
                if (modalEl && modalEl instanceof Element) {
                    // set very high z-index for modal
                    modalEl.style.zIndex = '20000';
                    // find the most recent backdrop and set slightly lower z-index
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    if (backdrops && backdrops.length) {
                        const lastBackdrop = backdrops[backdrops.length - 1];
                        lastBackdrop.style.zIndex = '19990';
                    }
                }
            } catch (err) {
                console.error('Error adjusting modal z-index:', err);
            }
        });
    </script>
</th:block>

</body>
</html>