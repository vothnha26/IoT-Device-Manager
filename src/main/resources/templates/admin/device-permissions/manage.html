<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{admin/layout :: admin-head('Quản lý Quyền Thiết Bị - IoT Manager')}"></th:block>
    <link rel="stylesheet" th:href="@{/css/admin-device-permissions.css}">
    <style>
        .device-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .device-item {
            padding: 15px;
            border: 1px solid #e9ecef;
            margin-bottom: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        .device-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .device-info {
            flex-grow: 1;
        }
        .device-name {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
        }
        .permission-buttons .btn {
            padding: 8px 16px;
            border-radius: 4px;
        }
        .add-device-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .section-title {
            color: #2c3e50;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .user-header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .user-details h3 {
            margin: 0;
            font-size: 1.5rem;
            color: #2c3e50;
        }
        .user-details p {
            margin: 5px 0 0;
            color: #7f8c8d;
        }
    </style>
</head>

<body class="admin-device-permissions">
    <!-- Sidebar -->
    <aside th:replace="~{admin/layout :: admin-sidebar}"></aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="top-header">
            <h2 class="page-title">Quản lý Quyền Thiết Bị</h2>
            <div th:replace="~{admin/layout :: admin-user-info}"></div>
        </div>

        <div class="content-wrapper p-4">
            <!-- User Information -->
            <div class="user-header">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <h3 th:text="${user.tenDangNhap}">Nguyễn Văn A</h3>
                    <p th:text="${user.email}">example@email.com</p>
                </div>
                <a href="/admin/device-permissions" class="btn btn-outline-primary ms-auto">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại
                </a>
            </div>

            <!-- Danh sách thiết bị được cấp quyền -->
            <div class="device-list">
                <h3 class="section-title">Thiết bị đã cấp quyền</h3>
                <div th:each="device : ${userDevices}" class="device-item">
                    <div class="device-info">
                        <span class="device-name" th:text="${device.tenThietBi}"></span>
                    </div>
                    <div class="permission-buttons">
                        <button class="btn btn-danger" 
                                th:onclick="'revokeAccess(' + ${userId} + ',' + ${device.maThietBi} + ')'">
                            <i class="fas fa-trash-alt me-1"></i>Thu hồi quyền
                        </button>
                    </div>
                </div>
                <div th:if="${#lists.isEmpty(userDevices)}" class="text-center text-muted py-3">
                    Chưa có thiết bị nào được cấp quyền
                </div>
            </div>
            
            <!-- Thêm quyền truy cập mới -->
            <div class="add-device-section">
                <h3 class="section-title">Thêm quyền truy cập thiết bị mới</h3>
                <div class="row">
                    <div class="col-md-8">
                        <select id="deviceSelect" class="form-select mb-3">
                            <option value="">Chọn thiết bị...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="grantAccess()">
                            <i class="fas fa-plus-circle me-1"></i>Cấp quyền
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i id="toastIcon" class="fas me-2"></i>
                <strong class="me-auto" id="toastTitle"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script th:inline="javascript">
        const userId = [[${userId}]];
        const toast = new bootstrap.Toast(document.getElementById('toast'));
        
        // Hiển thị thông báo
        function showToast(type, title, message) {
            const toastEl = document.getElementById('toast');
            const iconEl = document.getElementById('toastIcon');
            
            if (type === 'success') {
                iconEl.className = 'fas fa-check-circle text-success';
                toastEl.classList.remove('bg-danger');
                toastEl.classList.add('bg-success', 'text-white');
            } else {
                iconEl.className = 'fas fa-exclamation-circle text-danger';
                toastEl.classList.remove('bg-success');
                toastEl.classList.add('bg-danger', 'text-white');
            }
            
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            toast.show();
        }

        // Hiển thị/Ẩn loading spinner
        function toggleLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.toggle('d-none', !show);
        }

        // Load danh sách thiết bị có sẵn
        function loadAvailableDevices() {
            toggleLoading(true);
            $.ajax({
                url: '/admin/device-permissions/api/devices/available',
                method: 'GET',
                success: function(devices) {
                    const select = $('#deviceSelect');
                    select.empty().append('<option value="">Chọn thiết bị...</option>');
                    
                    devices.forEach(device => {
                        select.append(new Option(device.tenThietBi, device.id));
                    });
                },
                error: function(xhr) {
                    showToast('error', 'Lỗi', 'Không thể tải danh sách thiết bị');
                    console.error('Error loading devices:', xhr);
                },
                complete: function() {
                    toggleLoading(false);
                }
            });
        }

        // Cấp quyền truy cập
        function grantAccess() {
            const deviceId = $('#deviceSelect').val();
            if (!deviceId) {
                showToast('error', 'Lỗi', 'Vui lòng chọn thiết bị');
                return;
            }

            toggleLoading(true);
            $.ajax({
                url: '/admin/device-permissions/grant',
                method: 'POST',
                data: {
                    userId: userId,
                    deviceId: deviceId
                },
                success: function() {
                    showToast('success', 'Thành công', 'Đã cấp quyền truy cập thiết bị');
                    setTimeout(() => window.location.reload(), 1500);
                },
                error: function(xhr) {
                    showToast('error', 'Lỗi', 'Không thể cấp quyền truy cập');
                    console.error('Error granting access:', xhr);
                },
                complete: function() {
                    toggleLoading(false);
                }
            });
        }

        // Thu hồi quyền truy cập
        function revokeAccess(userId, deviceId) {
            if (!confirm('Bạn có chắc muốn thu hồi quyền truy cập thiết bị này?')) return;

            toggleLoading(true);
            $.ajax({
                url: '/admin/device-permissions/revoke',
                method: 'POST',
                data: {
                    userId: userId,
                    deviceId: deviceId
                },
                success: function() {
                    showToast('success', 'Thành công', 'Đã thu hồi quyền truy cập thiết bị');
                    setTimeout(() => window.location.reload(), 1500);
                },
                error: function(xhr) {
                    showToast('error', 'Lỗi', 'Không thể thu hồi quyền truy cập');
                    console.error('Error revoking access:', xhr);
                },
                complete: function() {
                    toggleLoading(false);
                }
            });
        }

        // Khởi tạo khi trang được load
        $(document).ready(function() {
            loadAvailableDevices();
        });
    </script>
</body>
</html>