<!DOCTYPE html>
<html lang="vi" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{admin/layout :: admin-head('Qu·∫£n l√Ω Ng∆∞·ªùi d√πng - IoT Manager')}"></head>

<body>
    <!-- Navbar -->
    <nav th:replace="~{admin/layout :: admin-navbar}"></nav>

    <!-- Sidebar -->
    <aside th:replace="~{admin/layout :: admin-sidebar}"></aside>

    <style>
        .main-content { min-height: 100vh; background-color: #f5f6fa; padding-top: 0; }
        .page-header { margin-bottom: 1.5rem; padding-top: 0; }
        .page-title { font-size: 1.75rem; font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem; margin-top: 0; }
        .page-subtitle { color: #718096; font-size: 0.95rem; }

        .filter-card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; }
        .users-table-card { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 25px; }

        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .table-title { font-size: 18px; font-weight: 600; color: #2c3e50; margin: 0; }

        .user-table { width: 100%; }
        .user-table th { background: #f8f9fa; padding: 12px; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #dee2e6; }
        .user-table td { padding: 15px 12px; vertical-align: middle; border-bottom: 1px solid #f0f0f0; }
        .user-table tr:hover { background: #f8f9fa; }

        .user-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; }

        .badge-role { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-user { background: #3498db; color: white; }
        .badge-manager { background: #e74c3c; color: white; }

        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }

        .action-btn { width: 32px; height: 32px; border-radius: 6px; border: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; margin: 0 3px; }
        .action-btn.view { background: #3498db; color: white; }
        .action-btn.view:hover { background: #2980b9; }
        .action-btn.toggle { background: #f39c12; color: white; }
        .action-btn.toggle:hover { background: #e67e22; }
        .action-btn.toggle.inactive { background: #27ae60; }
        .action-btn.toggle.inactive:hover { background: #229954; }

        .stats-row { display: flex; gap: 15px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 15px; transition: transform .2s ease, box-shadow .2s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
        .stat-icon.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.active { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-icon.inactive { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }
        .stat-info h3 { font-size: 28px; font-weight: bold; color: #2c3e50; margin: 0; }
        .stat-info p { margin: 0; color: #7f8c8d; font-size: 14px; }

        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state i { font-size: 64px; color: #bdc3c7; margin-bottom: 20px; }
        .empty-state h5 { color: #7f8c8d; margin-bottom: 10px; }
        .empty-state p { color: #95a5a6; }

        /* Keep modals above fixed navbar and offset below it */
        .modal { z-index: 1300; }
        .modal-backdrop { z-index: 1290; }
        .modal-dialog { margin-top: calc(var(--admin-navbar-height) + 12px); }
    </style>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container-fluid">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h1>
                <p class="page-subtitle">Qu·∫£n l√Ω t√†i kho·∫£n ng∆∞·ªùi d√πng trong h·ªá th·ªëng IoT</p>
            </div>

            <!-- Statistics -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-icon total">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalUsers">0</h3>
                        <p>T·ªïng s·ªë ng∆∞·ªùi d√πng</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon active">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="activeUsers">0</h3>
                        <p>Ng∆∞·ªùi d√πng k√≠ch ho·∫°t</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon inactive">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="inactiveUsers">0</h3>
                        <p>Ng∆∞·ªùi d√πng v√¥ hi·ªáu h√≥a</p>
                    </div>
                </div>
            </div>

            <!-- Filter Card -->
            <div class="filter-card">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo t√™n, email...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="roleFilter">
                            <option value="">T·∫•t c·∫£ vai tr√≤</option>
                            <option value="ROLE_USER">Ng∆∞·ªùi d√πng</option>
                            <option value="ROLE_ADMIN">Qu·∫£n tr·ªã vi√™n</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                            <option value="true">ƒê√£ k√≠ch ho·∫°t</option>
                            <option value="false">V√¥ hi·ªáu h√≥a</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="users-table-card">
                <div class="table-header">
                    <h2 class="table-title">
                        <i class="fas fa-list me-2"></i>
                        Danh s√°ch Ng∆∞·ªùi d√πng
                    </h2>
                </div>

                <div class="table-responsive">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>Ng∆∞·ªùi d√πng</th>
                                <th>Email</th>
                                <th>Vai tr√≤</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Ng√†y t·∫°o</th>
                                <th style="width: 150px;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal fade" id="userDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-person-badge"></i> Chi ti·∫øt Ng∆∞·ªùi d√πng</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Th√¥ng tin c∆° b·∫£n</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-muted">T√™n ƒëƒÉng nh·∫≠p:</td>
                                    <td><strong id="detailUsername">-</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Email:</td>
                                    <td id="detailEmail">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Vai tr√≤:</td>
                                    <td id="detailRoles">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Tr·∫°ng th√°i:</td>
                                    <td id="detailStatus">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Ng√†y t·∫°o:</td>
                                    <td id="detailCreated">-</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Th·ªëng k√™ s·ª≠ d·ª•ng</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-muted">Khu v·ª±c:</td>
                                    <td><strong id="detailAreas">0</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Thi·∫øt b·ªã:</td>
                                    <td><strong id="detailDevices">0</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Thi·∫øt b·ªã ho·∫°t ƒë·ªông:</td>
                                    <td><strong id="detailActiveDevices">0</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <hr>
                    <h6 class="text-muted mb-3">Danh s√°ch Khu v·ª±c</h6>
                    <div id="detailAreasList" class="mb-3"><p class="text-muted">ƒêang t·∫£i...</p></div>
                    <h6 class="text-muted mb-3">Danh s√°ch Thi·∫øt b·ªã</h6>
                    <div id="detailDevicesList"><p class="text-muted">ƒêang t·∫£i...</p></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let allUsers = [];
        const userDetailModal = new bootstrap.Modal(document.getElementById('userDetailModal'));

        function logout(){ document.cookie = 'authToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;'; window.location.href='/auth/login'; }

        function loadUsers(){ $.ajax({ url:'/api/admin/users', method:'GET', success:function(users){ allUsers = users; updateStatistics(); renderUsers(users); }, error:function(){ console.error('Error loading users'); } }); }

        function updateStatistics(){ const total = allUsers.length; const active = allUsers.filter(u=>u.kichHoat).length; document.getElementById('totalUsers').textContent = total; document.getElementById('activeUsers').textContent = active; document.getElementById('inactiveUsers').textContent = total - active; }

        function renderUsers(users){
            const tbody = document.getElementById('usersTableBody');
            if(!tbody) return;
            if(users.length===0){
                tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><i class="fas fa-users"></i><h5>Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o</h5><p>Danh s√°ch ng∆∞·ªùi d√πng tr·ªëng ho·∫∑c kh√¥ng kh·ªõp v·ªõi b·ªô l·ªçc.</p></div></td></tr>`;
                return;
            }
            tbody.innerHTML='';
            users.forEach((user,index)=>{
                const roles = user.vaiTro||[];
                const isAdmin = roles.some(r=>r.tenVaiTro==='ROLE_ADMIN');
                const avatarBg = isAdmin? '#e74c3c':'#3498db';
                const initial = user.tenDangNhap? user.tenDangNhap.charAt(0).toUpperCase():'U';
                const actionsHtml = isAdmin ? '' : `
                        <button class="action-btn view" onclick="viewUserDetail(${user.maNguoiDung})" title="Xem chi ti·∫øt"><i class="fas fa-eye"></i></button>
                        <button class="action-btn toggle ${!user.kichHoat?'inactive':''}" onclick="toggleUserStatus(${user.maNguoiDung})" title="${user.kichHoat?'V√¥ hi·ªáu h√≥a':'K√≠ch ho·∫°t'}"><i class="fas ${user.kichHoat?'fa-ban':'fa-check'}"></i></button>`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index+1}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="user-avatar" style="background: ${avatarBg}">${initial}</div>
                            <strong>${user.tenDangNhap||'N/A'}</strong>
                        </div>
                    </td>
                    <td>${user.email||'N/A'}</td>
                    <td>${roles.map(r=>`<span class="badge-role ${r.tenVaiTro==='ROLE_ADMIN'?'badge-manager':'badge-user'}">${r.tenVaiTro==='ROLE_ADMIN'?'Qu·∫£n tr·ªã vi√™n':'Ng∆∞·ªùi d√πng'}</span>`).join('')}</td>
                    <td><span class="status-badge ${user.kichHoat?'status-active':'status-inactive'}">${user.kichHoat?'<i class="fas fa-check-circle"></i> ƒê√£ k√≠ch ho·∫°t':'<i class="fas fa-times-circle"></i> V√¥ hi·ªáu h√≥a'}</span></td>
                    <td>${user.ngayTao?new Date(user.ngayTao).toLocaleDateString('vi-VN'):'N/A'}</td>
                    <td>${actionsHtml}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyFilters(){
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase()||'';
            const roleFilter = document.getElementById('roleFilter')?.value||'';
            const statusFilter = document.getElementById('statusFilter')?.value||'';
            let filtered = allUsers;
            if(searchTerm) filtered = filtered.filter(u=> (u.tenDangNhap&&u.tenDangNhap.toLowerCase().includes(searchTerm)) || (u.email&&u.email.toLowerCase().includes(searchTerm)));
            if(roleFilter) filtered = filtered.filter(u=> u.vaiTro && u.vaiTro.some(r=>r.tenVaiTro===roleFilter));
            if(statusFilter!=='') { const isActive = statusFilter==='true'; filtered = filtered.filter(u=>u.kichHoat===isActive); }
            renderUsers(filtered);
        }

        function toggleUserStatus(userId){
            if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën thay ƒë·ªïi tr·∫°ng th√°i c·ªßa ng∆∞·ªùi d√πng n√†y?')) return;
            $.ajax({ url:`/api/admin/users/${userId}/toggle-active`, method:'PUT', success:function(){ loadUsers(); }, error:function(){ alert('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i'); } });
        }

        function viewUserDetail(userId){
            $.ajax({ url:`/api/admin/users/${userId}`, method:'GET', success:function(user){ displayUserDetail(user); } });
            $.ajax({ url:`/api/admin/users/${userId}/statistics`, method:'GET', success:function(stats){ document.getElementById('detailAreas').textContent = stats.totalAreas||0; document.getElementById('detailDevices').textContent = stats.totalDevices||0; document.getElementById('detailActiveDevices').textContent = stats.activeDevices||0; } });
            $.ajax({ url:`/api/admin/users/${userId}/areas`, method:'GET', success:function(areas){ const c=document.getElementById('detailAreasList'); c.innerHTML = areas.length? areas.map(a=>`<span class="badge bg-primary me-2">${a.tenKhuVuc}</span>`).join('') : '<p class="text-muted">Ch∆∞a c√≥ khu v·ª±c n√†o</p>'; } });
            $.ajax({ url:`/api/admin/users/${userId}/devices`, method:'GET', success:function(devices){ const c=document.getElementById('detailDevicesList'); c.innerHTML = devices.length? devices.map(d=>`<span class="badge bg-success me-2">${d.tenThietBi}</span>`).join('') : '<p class="text-muted">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o</p>'; } });
            userDetailModal.show();
        }

        function displayUserDetail(user){
            document.getElementById('detailUsername').textContent = user.tenDangNhap||'N/A';
            document.getElementById('detailEmail').textContent = user.email||'N/A';
            document.getElementById('detailRoles').innerHTML = (user.vaiTro||[]).map(r=>`<span class="badge-role ${r.tenVaiTro==='ROLE_ADMIN'?'badge-manager':'badge-user'}">${r.tenVaiTro==='ROLE_ADMIN'?'Qu·∫£n tr·ªã vi√™n':'Ng∆∞·ªùi d√πng'}</span>`).join('');
            document.getElementById('detailStatus').innerHTML = `<span class="status-badge ${user.kichHoat?'status-active':'status-inactive'}">${user.kichHoat?'ƒê√£ k√≠ch ho·∫°t':'V√¥ hi·ªáu h√≥a'}</span>`;
            document.getElementById('detailCreated').textContent = user.ngayTao? new Date(user.ngayTao).toLocaleString('vi-VN') : 'N/A';
        }

        document.addEventListener('DOMContentLoaded', function(){
            loadUsers();
            document.getElementById('searchInput')?.addEventListener('input', applyFilters);
            document.getElementById('roleFilter')?.addEventListener('change', applyFilters);
            document.getElementById('statusFilter')?.addEventListener('change', applyFilters);
        });
    </script>
</body>
</html>
