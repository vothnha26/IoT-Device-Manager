<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <th:block th:replace="~{admin/layout :: admin-head('Qu·∫£n l√Ω Ng∆∞·ªùi d√πng - IoT Manager')}"></th:block>
    <style>
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .badge-role {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-user {
            background: #3498db;
            color: white;
        }

        .badge-manager {
            background: #e74c3c;
            color: white;
        }

        .badge-admin {
            background: #9b59b6;
            color: white;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0 3px;
        }

        .action-btn.view {
            background: #3498db;
            color: white;
        }

        .action-btn.view:hover {
            background: #2980b9;
        }

        .action-btn.toggle {
            background: #f39c12;
            color: white;
        }

        .action-btn.toggle:hover {
            background: #e67e22;
        }

        .action-btn.toggle.inactive {
            background: #27ae60;
        }

        .action-btn.toggle.inactive:hover {
            background: #229954;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: #bdc3c7;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav th:replace="~{admin/layout :: admin-navbar}"></nav>
    
    <!-- Admin Layout Container -->
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside th:replace="~{admin/layout :: admin-sidebar}"></aside>

        <!-- Main Content -->
        <div class="content-wrapper">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="mb-4">
                    <h1 class="admin-card-title mb-1">
                        <i class="fas fa-users-cog"></i>
                        Qu·∫£n l√Ω Ng∆∞·ªùi d√πng
                    </h1>
                    <p class="text-muted">Qu·∫£n l√Ω t√†i kho·∫£n ng∆∞·ªùi d√πng trong h·ªá th·ªëng IoT</p>
                </div>

                <!-- Statistics -->
                <div class="admin-stats-grid mb-4">
                    <div class="admin-stat-card">
                        <div class="admin-stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="admin-stat-info">
                            <h4 id="totalUsers">0</h4>
                            <p>T·ªïng s·ªë ng∆∞·ªùi d√πng</p>
                        </div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%)">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="admin-stat-info">
                            <h4 id="activeUsers">0</h4>
                            <p>Ng∆∞·ªùi d√πng k√≠ch ho·∫°t</p>
                        </div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-icon" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%)">
                            <i class="fas fa-user-slash"></i>
                        </div>
                        <div class="admin-stat-info">
                            <h4 id="inactiveUsers">0</h4>
                            <p>Ng∆∞·ªùi d√πng v√¥ hi·ªáu h√≥a</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Card -->
                <div class="admin-card mb-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo t√™n, email...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="roleFilter">
                                <option value="">T·∫•t c·∫£ vai tr√≤</option>
                                <option value="ROLE_USER">Ng∆∞·ªùi d√πng</option>
                                <option value="ROLE_MANAGER">Qu·∫£n tr·ªã vi√™n</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="true">ƒê√£ k√≠ch ho·∫°t</option>
                                <option value="false">V√¥ hi·ªáu h√≥a</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-filter me-2"></i>L·ªçc
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h5 class="admin-card-title">
                            <i class="fas fa-list"></i>
                            Danh s√°ch Ng∆∞·ªùi d√πng
                        </h5>
                        <div class="admin-card-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadUsers()">
                                <i class="fas fa-sync-alt me-2"></i>L√†m m·ªõi
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="admin-table table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">#</th>
                                    <th>Email</th>
                                    <th>Vai tr√≤</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th>Ng√†y t·∫°o</th>
                                    <th style="width: 150px;">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal fade" id="userDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--admin-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-user-circle me-2"></i>Chi ti·∫øt Ng∆∞·ªùi d√πng
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Th√¥ng tin c∆° b·∫£n</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-muted">T√™n ƒëƒÉng nh·∫≠p:</td>
                                    <td><strong id="detailUsername">-</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Email:</td>
                                    <td id="detailEmail">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Vai tr√≤:</td>
                                    <td id="detailRoles">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Tr·∫°ng th√°i:</td>
                                    <td id="detailStatus">-</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Ng√†y t·∫°o:</td>
                                    <td id="detailCreated">-</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Th·ªëng k√™ s·ª≠ d·ª•ng</h6>
                            <table class="table table-borderless">
                                <tr>
                                    <td class="text-muted">G√≥i hi·ªán t·∫°i:</td>
                                    <td><strong id="detailPackage">-</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">D·ª± √°n:</td>
                                    <td><strong id="detailProjects">0</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Khu v·ª±c:</td>
                                    <td><strong id="detailAreas">0</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Thi·∫øt b·ªã:</td>
                                    <td><strong id="detailDevices">0</strong></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Thi·∫øt b·ªã ho·∫°t ƒë·ªông:</td>
                                    <td><strong id="detailActiveDevices">0</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6 class="text-muted mb-3">Danh s√°ch Khu v·ª±c</h6>
                    <div id="detailAreasList" class="mb-3">
                        <p class="text-muted">ƒêang t·∫£i...</p>
                    </div>
                    
                    <h6 class="text-muted mb-3">Danh s√°ch Thi·∫øt b·ªã</h6>
                    <div id="detailDevicesList">
                        <p class="text-muted">ƒêang t·∫£i...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Package Modal -->
    <div class="modal fade" id="assignPackageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--admin-primary); color: white;">
                    <h5 class="modal-title">
                        <i class="fas fa-gift me-2"></i>G√°n g√≥i c∆∞·ªõc cho User
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="assignUserId">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Email:</strong> <span id="assignUserEmail"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ch·ªçn g√≥i c∆∞·ªõc <span class="text-danger">*</span></label>
                        <select class="form-select" id="assignPackageSelect" required>
                            <option value="">-- Ch·ªçn g√≥i c∆∞·ªõc --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Th·ªùi h·∫°n (th√°ng) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="assignDuration" value="1" min="1" max="12" required>
                        <small class="text-muted">S·ªë th√°ng s·ª≠ d·ª•ng g√≥i (1-12 th√°ng)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Ghi ch√∫</label>
                        <textarea class="form-control" id="assignNote" rows="3" placeholder="Ghi ch√∫ v·ªÅ vi·ªác g√°n g√≥i (t√πy ch·ªçn)"></textarea>
                    </div>
                    
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>L∆∞u √Ω:</strong> G√≥i c∆∞·ªõc s·∫Ω ƒë∆∞·ª£c k√≠ch ho·∫°t ngay l·∫≠p t·ª©c v√† t·ª± ƒë·ªông t·∫°o b·∫£n ghi thanh to√°n.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success" onclick="confirmAssignPackage()">
                        <i class="fas fa-check me-2"></i>X√°c nh·∫≠n g√°n g√≥i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{admin/layout :: admin-footer}"></footer>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let allUsers = [];
        const userDetailModal = new bootstrap.Modal(document.getElementById('userDetailModal'));

        // Load users from API
        function loadUsers() {
            $.ajax({
                url: '/api/admin/users',
                method: 'GET',
                success: function(users) {
                    allUsers = users;
                    updateStatistics();
                    renderUsers(users);
                },
                error: function(xhr) {
                    console.error('Error loading users:', xhr);
                    showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng');
                }
            });
        }

        // Update statistics
        function updateStatistics() {
            const total = allUsers.length;
            const active = allUsers.filter(u => u.kichHoat).length;
            const inactive = total - active;
            
            document.getElementById('totalUsers').textContent = total;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('inactiveUsers').textContent = inactive;
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h5>Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o</h5>
                                <p>Danh s√°ch ng∆∞·ªùi d√πng tr·ªëng ho·∫∑c kh√¥ng kh·ªõp v·ªõi b·ªô l·ªçc.</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            users.forEach((user, index) => {
                const roles = user.vaiTro || [];
                const isManager = roles.some(r => r.tenVaiTro === 'ROLE_MANAGER');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>
                        ${roles.map(r => {
                            let badgeClass = 'badge-user';
                            let roleName = 'Ng∆∞·ªùi d√πng';
                            
                            if (r.tenVaiTro === 'ROLE_ADMIN') {
                                badgeClass = 'badge-admin';
                                roleName = 'Admin';
                            } else if (r.tenVaiTro === 'ROLE_MANAGER') {
                                badgeClass = 'badge-manager';
                                roleName = 'Qu·∫£n tr·ªã vi√™n';
                            }
                            
                            return `<span class="badge-role ${badgeClass}">
                                ${roleName}
                            </span>`;
                        }).join(' ')}
                    </td>
                    <td>
                        <span class="status-badge ${user.kichHoat ? 'status-active' : 'status-inactive'}">
                            <i class="fas ${user.kichHoat ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                            ${user.kichHoat ? 'ƒê√£ k√≠ch ho·∫°t' : 'V√¥ hi·ªáu h√≥a'}
                        </span>
                    </td>
                    <td>${user.ngayTao ? new Date(user.ngayTao).toLocaleDateString('vi-VN') : 'N/A'}</td>
                    <td>
                        <button class="action-btn view" onclick="viewUserDetail(${user.maNguoiDung})" title="Xem chi ti·∫øt">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" style="background: #28a745; color: white;" 
                                onclick="assignPackage(${user.maNguoiDung}, '${user.email}')" 
                                title="G√°n g√≥i c∆∞·ªõc">
                            <i class="fas fa-gift"></i>
                        </button>
                        <button class="action-btn toggle ${!user.kichHoat ? 'inactive' : ''}" 
                                onclick="toggleUserStatus(${user.maNguoiDung})" 
                                title="${user.kichHoat ? 'V√¥ hi·ªáu h√≥a' : 'K√≠ch ho·∫°t'}">
                            <i class="fas ${user.kichHoat ? 'fa-ban' : 'fa-check'}"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Apply filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = allUsers;
            
            if (searchTerm) {
                filtered = filtered.filter(u => 
                    (u.tenDangNhap && u.tenDangNhap.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm))
                );
            }
            
            if (roleFilter) {
                filtered = filtered.filter(u => 
                    u.vaiTro && u.vaiTro.some(r => r.tenVaiTro === roleFilter)
                );
            }
            
            if (statusFilter !== '') {
                const isActive = statusFilter === 'true';
                filtered = filtered.filter(u => u.kichHoat === isActive);
            }
            
            renderUsers(filtered);
        }

        // Toggle user status
        function toggleUserStatus(userId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën thay ƒë·ªïi tr·∫°ng th√°i c·ªßa ng∆∞·ªùi d√πng n√†y?')) {
                return;
            }
            
            $.ajax({
                url: `/api/admin/users/${userId}/toggle-active`,
                method: 'PUT',
                success: function(response) {
                    alert('‚úÖ ' + (response.message || 'ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ng∆∞·ªùi d√πng'));
                    loadUsers();
                },
                error: function(xhr) {
                    alert('‚ùå L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i: ' + (xhr.responseText || 'Unknown error'));
                }
            });
        }

        // View user detail
        function viewUserDetail(userId) {
            $.ajax({
                url: `/api/admin/users/${userId}`,
                method: 'GET',
                success: function(user) {
                    displayUserDetail(user);
                }
            });
            
            $.ajax({
                url: `/api/admin/users/${userId}/statistics`,
                method: 'GET',
                success: function(stats) {
                    document.getElementById('detailPackage').textContent = stats.currentPackage || 'Ch∆∞a c√≥ g√≥i';
                    document.getElementById('detailProjects').textContent = stats.totalProjects || 0;
                    document.getElementById('detailAreas').textContent = stats.totalAreas || 0;
                    document.getElementById('detailDevices').textContent = stats.totalDevices || 0;
                    document.getElementById('detailActiveDevices').textContent = stats.activeDevices || 0;
                },
                error: function(xhr) {
                    console.error('Error loading statistics:', xhr);
                }
            });
            
            $.ajax({
                url: `/api/admin/users/${userId}/areas`,
                method: 'GET',
                success: function(areas) {
                    const container = document.getElementById('detailAreasList');
                    if (areas && areas.length === 0) {
                        container.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>Ch∆∞a c√≥ khu v·ª±c n√†o</p>';
                    } else if (areas && areas.length > 0) {
                        container.innerHTML = '<div class="d-flex flex-wrap gap-2">' + 
                            areas.map(a => 
                                `<span class="badge bg-primary">${a.tenKhuVuc || 'N/A'}</span>`
                            ).join('') + '</div>';
                    } else {
                        container.innerHTML = '<p class="text-muted mb-0">Ch∆∞a c√≥ khu v·ª±c n√†o</p>';
                    }
                },
                error: function(xhr) {
                    console.error('Error loading areas:', xhr);
                    document.getElementById('detailAreasList').innerHTML = 
                        '<p class="text-danger mb-0"><i class="fas fa-exclamation-triangle me-2"></i>L·ªói khi t·∫£i danh s√°ch khu v·ª±c</p>';
                }
            });
            
            $.ajax({
                url: `/api/admin/users/${userId}/devices`,
                method: 'GET',
                success: function(devices) {
                    const container = document.getElementById('detailDevicesList');
                    if (devices && devices.length === 0) {
                        container.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>Ch∆∞a c√≥ thi·∫øt b·ªã n√†o</p>';
                    } else if (devices && devices.length > 0) {
                        container.innerHTML = '<div class="d-flex flex-wrap gap-2">' + 
                            devices.map(d => 
                                `<span class="badge bg-success">${d.tenThietBi || 'N/A'}</span>`
                            ).join('') + '</div>';
                    } else {
                        container.innerHTML = '<p class="text-muted mb-0">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o</p>';
                    }
                },
                error: function(xhr) {
                    console.error('Error loading devices:', xhr);
                    document.getElementById('detailDevicesList').innerHTML = 
                        '<p class="text-danger mb-0"><i class="fas fa-exclamation-triangle me-2"></i>L·ªói khi t·∫£i danh s√°ch thi·∫øt b·ªã</p>';
                }
            });
            
            userDetailModal.show();
        }

        // Display user detail in modal
        function displayUserDetail(user) {
            document.getElementById('detailUsername').textContent = user.tenDangNhap || 'N/A';
            document.getElementById('detailEmail').textContent = user.email || 'N/A';
            
            const roles = user.vaiTro || [];
            document.getElementById('detailRoles').innerHTML = roles.map(r => {
                let badgeClass = 'badge-user';
                let roleName = 'Ng∆∞·ªùi d√πng';
                
                if (r.tenVaiTro === 'ROLE_ADMIN') {
                    badgeClass = 'badge-admin';
                    roleName = 'Admin';
                } else if (r.tenVaiTro === 'ROLE_MANAGER') {
                    badgeClass = 'badge-manager';
                    roleName = 'Qu·∫£n tr·ªã vi√™n';
                }
                
                return `<span class="badge-role ${badgeClass}">
                    ${roleName}
                </span>`;
            }).join(' ');
            
            document.getElementById('detailStatus').innerHTML = `
                <span class="status-badge ${user.kichHoat ? 'status-active' : 'status-inactive'}">
                    ${user.kichHoat ? 'ƒê√£ k√≠ch ho·∫°t' : 'V√¥ hi·ªáu h√≥a'}
                </span>
            `;
            
            document.getElementById('detailCreated').textContent = 
                user.ngayTao ? new Date(user.ngayTao).toLocaleString('vi-VN') : 'N/A';
        }

        // Assign package to user
        const assignPackageModal = new bootstrap.Modal(document.getElementById('assignPackageModal'));
        
        function assignPackage(userId, userEmail) {
            document.getElementById('assignUserId').value = userId;
            document.getElementById('assignUserEmail').textContent = userEmail;
            document.getElementById('assignDuration').value = 1;
            document.getElementById('assignNote').value = '';
            
            // Load available packages
            $.ajax({
                url: '/api/goi-cuoc',
                method: 'GET',
                success: function(packages) {
                    const select = document.getElementById('assignPackageSelect');
                    select.innerHTML = '<option value="">-- Ch·ªçn g√≥i c∆∞·ªõc --</option>';
                    packages.forEach(pkg => {
                        select.innerHTML += `<option value="${pkg.maGoiCuoc}">
                            ${pkg.tenGoi} - ${pkg.giaTien.toLocaleString('vi-VN')}ƒë/${pkg.thoiHan} th√°ng
                        </option>`;
                    });
                    assignPackageModal.show();
                },
                error: function(xhr) {
                    showError('Kh√¥ng th·ªÉ t·∫£i danh s√°ch g√≥i c∆∞·ªõc');
                }
            });
        }
        
        function confirmAssignPackage() {
            const userId = document.getElementById('assignUserId').value;
            const packageId = document.getElementById('assignPackageSelect').value;
            const duration = document.getElementById('assignDuration').value;
            const note = document.getElementById('assignNote').value;
            
            if (!packageId) {
                alert('Vui l√≤ng ch·ªçn g√≥i c∆∞·ªõc');
                return;
            }
            
            if (!duration || duration < 1 || duration > 12) {
                alert('Th·ªùi h·∫°n ph·∫£i t·ª´ 1-12 th√°ng');
                return;
            }
            
            if (!confirm(`X√°c nh·∫≠n g√°n g√≥i c∆∞·ªõc cho user n√†y trong ${duration} th√°ng?`)) {
                return;
            }
            
            $.ajax({
                url: '/api/admin/users/' + userId + '/assign-package',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    maGoiCuoc: parseInt(packageId),
                    soThang: parseInt(duration),
                    ghiChu: note
                }),
                success: function(response) {
                    alert('‚úÖ G√°n g√≥i c∆∞·ªõc th√†nh c√¥ng!');
                    assignPackageModal.hide();
                    loadUsers(); // Reload table
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.message || 'C√≥ l·ªói x·∫£y ra khi g√°n g√≥i c∆∞·ªõc';
                    showError(error);
                }
            });
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        // Real-time search
        document.getElementById('searchInput').addEventListener('input', function() {
            applyFilters();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });
    </script>
</body>
</html>
