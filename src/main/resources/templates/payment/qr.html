<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Thanh to√°n QR</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .qr-wrapper{max-width:520px;margin:40px auto;padding:24px;border:1px solid #e3e8ee;border-radius:16px;background:#fff;box-shadow:0 8px 24px rgba(16,24,40,.08)}
    .qr-title{display:flex;align-items:center;gap:10px;margin-bottom:4px;font-weight:700;color:#0f172a}
    .qr-sub{color:#475569;margin-bottom:16px}
    .qr-img{display:flex;justify-content:center;margin:16px 0}
    .qr-img img{max-width:320px;width:100%;height:auto;border-radius:12px;border:1px solid #e2e8f0}
    .qr-meta{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border:1px dashed #cbd5e1;border-radius:10px;padding:12px 14px;margin-top:8px}
    .qr-actions{display:flex;gap:10px;justify-content:center;margin-top:16px}
    .payment-status{margin-top:16px;padding:12px;border-radius:8px;text-align:center;display:none}
    .payment-status.success{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
    .payment-status.pending{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
  </style>
</head>
<body class="bg-light">
  <div class="container">
    <div class="qr-wrapper">
      <div class="qr-title">
        <i class="bi bi-qr-code"></i>
        <span>Thanh to√°n cho g√≥i</span>
        <strong th:text="${goiCuoc.tenGoi}">G√≥i</strong>
      </div>
      <div class="qr-sub">
        S·ªë ti·ªÅn: <strong th:text="${#numbers.formatDecimal(amount, 0, 'COMMA', 0, 'POINT')}">0</strong> VND
      </div>

      <!-- Payment status notification -->
      <div id="paymentStatus" class="payment-status pending">
        <i class="bi bi-hourglass-split"></i>
        <span>ƒêang ch·ªù thanh to√°n...</span>
      </div>

      <div class="qr-img">
        <img th:src="${qrImageUrl}" alt="QR thanh to√°n" />
      </div>

      <div class="qr-meta">
        <div>
          <div class="small text-muted">H∆∞·ªõng d·∫´n</div>
          <div class="small">M·ªü app ng√¢n h√†ng, ch·ªçn Qu√©t QR v√† x√°c nh·∫≠n thanh to√°n.</div>
        </div>
        <a th:href="@{/}" class="btn btn-outline-secondary btn-sm">V·ªÅ trang ch·ªß</a>
      </div>

      <div class="qr-actions">
        <a th:href="${qrImageUrl}" target="_blank" class="btn btn-primary">M·ªü ·∫£nh QR</a>
        <a th:href="@{/notifications}" class="btn btn-outline-primary">Xem th√¥ng b√°o</a>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/sockjs.min.js}"></script>
  <script th:src="@{/js/stomp.min.js}"></script>
  <script th:inline="javascript">
    const orderId = /*[[${orderId}]]*/ '0';
    console.log('Payment page loaded. Order ID:', orderId);
    
    let stompClient = null;
    
    function connect() {
      console.log('Connecting to WebSocket...');
      const statusDiv = document.getElementById('paymentStatus');
      statusDiv.style.display = 'block';
      
      const socket = new SockJS('/stomp');
      stompClient = Stomp.over(socket);
      
      stompClient.connect({}, function(frame) {
        console.log('‚úÖ WebSocket connected:', frame);
        
        // Subscribe to payment notifications for this order
        stompClient.subscribe('/topic/payment/' + orderId, function(message) {
          console.log('üì® Payment notification received:', message.body);
          const payload = JSON.parse(message.body);
          handlePaymentNotification(payload);
        });
        
        console.log('‚úÖ Subscribed to /topic/payment/' + orderId);
      }, function(error) {
        console.error('‚ùå WebSocket connection error:', error);
        statusDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Kh√¥ng th·ªÉ k·∫øt n·ªëi WebSocket';
      });
    }
    
    function handlePaymentNotification(payload) {
      console.log('Processing payment notification:', payload);
      const statusDiv = document.getElementById('paymentStatus');
      
      if (payload.type === 'PAYMENT_SUCCESS') {
        statusDiv.className = 'payment-status success';
        statusDiv.innerHTML = '<i class="bi bi-check-circle-fill"></i> <strong>Thanh to√°n th√†nh c√¥ng!</strong> ƒêang chuy·ªÉn t·ªõi trang ng∆∞·ªùi d√πng...';
        
        // Redirect to user profile immediately after short delay
        setTimeout(function() {
          window.location.href = '/profile';
        }, 1200);
      }
    }
    
    function disconnect() {
      if (stompClient !== null) {
        stompClient.disconnect();
        console.log('WebSocket disconnected');
      }
    }
    
    // Connect when page loads
    window.addEventListener('load', connect);
    
    // Disconnect when page unloads
    window.addEventListener('beforeunload', disconnect);
  </script>
</body>
</html>
