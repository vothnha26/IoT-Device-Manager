<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Qu·∫£n l√Ω Lu·∫≠t - [[${thietBi.tenThietBi}]]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script th:src="@{/js/sockjs.min.js}"></script>
    <script th:src="@{/js/stomp.min.js}"></script>
    <style>
        body { background: #f5f5f5; padding: 20px; }
        .rule-card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 5px; border-left: 4px solid #007bff; }
        .rule-card.inactive { opacity: 0.6; border-left-color: #ccc; }
        .condition-row { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .logic-operator { background: #e9ecef; padding: 5px 15px; border-radius: 3px; margin: 5px 0; display: inline-block; }
        .expression-preview { background: #e7f3ff; border: 1px solid #b8daff; padding: 10px; border-radius: 5px; margin-top: 10px; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between mb-4">
            <div>
                <h3>‚öôÔ∏è Qu·∫£n L√Ω Lu·∫≠t T·ª± ƒê·ªông</h3>
                <p class="text-muted">Thi·∫øt b·ªã: <strong th:text="${thietBi.tenThietBi}">-</strong></p>
            </div>
            <div>
                <a th:href="@{/thiet-bi/khu-vuc/{id}(id=${thietBi.khuVuc.maKhuVuc})}" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#ruleModal" onclick="openCreateModal()">+ T·∫°o Lu·∫≠t</button>
            </div>
        </div>

        <div class="alert alert-info">
            <strong>üí° H∆∞·ªõng d·∫´n:</strong> Ch·ªâ d√πng <b>Bi·ªÉu th·ª©c</b>. V√≠ d·ª•: <code>nhiet_do &gt; 30 AND do_am &lt; 70</code>. Tr∆∞·ªùng h·ª£p ƒë∆°n gi·∫£n v·∫´n c√≥ th·ªÉ vi·∫øt: <code>nhiet_do &gt; 30</code>. Duy tr√¨: ƒëi·ªÅu ki·ªán ph·∫£i ƒë√∫ng X gi√¢y.
        </div>

        <div th:if="${#lists.isEmpty(rules)}" class="text-center py-5">
            <h4 class="text-muted">üì≠ Ch∆∞a c√≥ lu·∫≠t</h4>
        </div>

        <div th:each="rule : ${rules}" class="rule-card" th:classappend="${!rule.kichHoat ? 'inactive' : ''}" th:attr="data-rule-id=${rule.maLuat}">
            <div class="row">
                <div class="col-md-9">
                    <span class="badge bg-primary">üîó Bi·ªÉu th·ª©c</span>
                    <span th:if="${rule.kichHoat}" class="badge bg-success">‚úÖ ON</span>
                    <span th:if="${!rule.kichHoat}" class="badge bg-secondary">‚è∏Ô∏è OFF</span>

                    <div class="mt-2">
                        <strong>ƒêi·ªÅu ki·ªán:</strong>
                        <code th:text="${#strings.isEmpty(rule.bieuThucLogic) ? '-' : rule.bieuThucLogic}"></code>
                    </div>

                    <div th:if="${rule.thoiGianDuyTriDieuKien != null and rule.thoiGianDuyTriDieuKien > 0}">
                        <small>‚è±Ô∏è Duy tr√¨: <strong th:text="${rule.thoiGianDuyTriDieuKien}"></strong>s</small>
                    </div>

                    <div>
                        <strong>H√†nh ƒë·ªông:</strong>
                        <span th:if="${#strings.containsIgnoreCase(rule.lenhHanhDong, 'hoat_dong') or #strings.containsIgnoreCase(rule.lenhHanhDong, 'bat')}" class="badge bg-success">üü¢ B·∫¨T</span>
                        <span th:if="${#strings.containsIgnoreCase(rule.lenhHanhDong, 'tat')}" class="badge bg-danger">üî¥ T·∫ÆT</span>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <button class="btn btn-sm btn-info" th:attr="data-rule-id=${rule.maLuat}" onclick="toggleRuleLogs(this)" title="Xem l·ªãch s·ª≠ c·∫£nh b√°o">
                        üëÅÔ∏è Log
                    </button>
                    <button class="btn btn-sm btn-primary" th:onclick="'editRule(' + ${rule.maLuat} + ')'">‚úèÔ∏è</button>
                    <button class="btn btn-sm" th:classappend="${rule.kichHoat ? 'btn-warning' : 'btn-success'}" th:onclick="'toggleRule(' + ${rule.maLuat} + ', ' + ${!rule.kichHoat} + ')'">
                        <span th:text="${rule.kichHoat ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}"></span>
                    </button>
                    <button class="btn btn-sm btn-danger" th:onclick="'deleteRule(' + ${rule.maLuat} + ')'">üóëÔ∏è</button>
                </div>
            </div>
            
            <!-- Log Panel (Hidden by default) -->
            <div class="log-panel" th:id="'logPanel-' + ${rule.maLuat}" style="display: none; margin-top: 15px; border-top: 2px dashed #ddd; padding-top: 15px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">
                        üìä L·ªãch S·ª≠ C·∫£nh B√°o 
                        <span class="badge bg-secondary" th:id="'logCount-' + ${rule.maLuat}">0</span>
                    </h6>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" th:id="'timeFilter-' + ${rule.maLuat}" onchange="filterLogs(this)" style="width: 150px;">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="today">H√¥m nay</option>
                            <option value="yesterday">H√¥m qua</option>
                            <option value="week">7 ng√†y qua</option>
                            <option value="month">30 ng√†y qua</option>
                        </select>
                        <button class="btn btn-sm btn-outline-secondary" th:onclick="'refreshLogs(' + ${rule.maLuat} + ')'">
                            üîÑ T·∫£i l·∫°i
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 60px;">#</th>
                                <th>N·ªôi dung</th>
                                <th style="width: 200px;">Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody th:id="'logTable-' + ${rule.maLuat}">
                            <tr>
                                <td colspan="3" class="text-center text-muted">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    ƒêang t·∫£i...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="text-center" th:id="'loadMoreBtn-' + ${rule.maLuat}" style="display: none;">
                    <button class="btn btn-sm btn-outline-primary" th:onclick="'loadMoreLogs(' + ${rule.maLuat} + ')'">
                        Xem th√™m...
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ruleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 id="modalTitle">T·∫°o Lu·∫≠t</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ruleForm">
                        <input type="hidden" id="ruleId">
                        <!-- Ch·ªâ d√πng Bi·ªÉu th·ª©c -->
                        <div id="expressionSection" class="mb-3">
                            <label><strong>Bi·ªÉu th·ª©c Logic</strong></label>
                            
                            <div id="conditionsContainer"></div>
                            
                            <button type="button" class="btn btn-sm btn-success" onclick="addCondition()">+ Th√™m ƒëi·ªÅu ki·ªán</button>
                            
                            <div class="expression-preview mt-3">
                                <strong>Bi·ªÉu th·ª©c:</strong> <span id="expressionPreview" class="text-primary">-</span>
                            </div>
                            <input type="hidden" id="bieuThucLogic">
                        </div>
                        <!-- Lo·∫°i Ng∆∞·ª°ng ƒë√£ lo·∫°i b·ªè -->
                        <div class="mb-3">
                            <label><strong>Duy tr√¨ (gi√¢y)</strong></label>
                            <input type="number" class="form-control" id="thoiGianDuyTriDieuKien" value="0" min="0">
                        </div>
                        <div class="mb-3">
                            <label><strong>H√†nh ƒë·ªông</strong></label>
                            <select class="form-select" id="lenhHanhDong">
                                <option value="hoat_dong">B·∫¨T</option>
                                <option value="tat">T·∫ÆT</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="kichHoat" checked>
                            <label class="form-check-label">K√≠ch ho·∫°t ngay</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button class="btn btn-primary" onclick="saveRule()">üíæ L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const deviceId = /*[[${thietBi.maThietBi}]]*/ 0;
        
        // L·∫•y CSRF token
        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
        
        console.log('CSRF Token:', csrfToken);
        console.log('CSRF Header:', csrfHeader);
        
        // Helper function ƒë·ªÉ th√™m CSRF v√† JWT (n·∫øu c√≥) v√†o fetch
        function fetchWithCSRF(url, options = {}) {
            if (!options.headers) {
                options.headers = {};
            }
            options.headers[csrfHeader] = csrfToken;
            options.headers['Content-Type'] = 'application/json';
            
            // ƒê·∫£m b·∫£o g·ª≠i credentials (cookies) ƒë·ªÉ h·ªó tr·ª£ session-based auth
            options.credentials = 'same-origin';
            
            // ƒê√≠nh k√®m JWT n·∫øu ·ª©ng d·ª•ng d√πng JwtAuthFilter
            try {
                const jwt = localStorage.getItem('jwt') || sessionStorage.getItem('jwt');
                if (jwt) {
                    options.headers['Authorization'] = `Bearer ${jwt}`;
                }
            } catch (e) {
                // ignore
            }
            console.log('Fetching:', url, 'with headers:', options.headers);
            return fetch(url, options);
        }
        /*]]>*/

        let conditions = [];
        let conditionCounter = 0;

        // Th√™m ƒëi·ªÅu ki·ªán m·ªõi
        function addCondition() {
            const id = conditionCounter++;
            const isFirst = conditions.length === 0;
            
            conditions.push({
                id: id,
                field: 'nhiet_do',
                operator: '>',
                value: '',
                logicOperator: isFirst ? null : 'AND'
            });
            
            renderConditions();
        }

        // X√≥a ƒëi·ªÅu ki·ªán
        function removeCondition(id) {
            conditions = conditions.filter(c => c.id !== id);
            // N·∫øu x√≥a ƒëi·ªÅu ki·ªán ƒë·∫ßu ti√™n, lo·∫°i b·ªè logic operator c·ªßa ƒëi·ªÅu ki·ªán m·ªõi ƒë·∫ßu ti√™n
            if (conditions.length > 0) {
                conditions[0].logicOperator = null;
            }
            renderConditions();
        }

        // C·∫≠p nh·∫≠t ƒëi·ªÅu ki·ªán
        function updateCondition(id, field, value) {
            const condition = conditions.find(c => c.id === id);
            if (condition) {
                condition[field] = value;
                buildExpression();
            }
        }

        // Render giao di·ªán c√°c ƒëi·ªÅu ki·ªán
        function renderConditions() {
            const container = document.getElementById('conditionsContainer');
            container.innerHTML = '';
            
            conditions.forEach((cond, index) => {
                const div = document.createElement('div');
                div.className = 'condition-row';
                
                let html = '';
                
                // Logic operator (AND/OR) - ch·ªâ hi·ªÉn th·ªã t·ª´ ƒëi·ªÅu ki·ªán th·ª© 2 tr·ªü ƒëi
                if (index > 0) {
                    html += `
                        <div class="mb-2">
                            <select class="form-select form-select-sm d-inline-block w-auto logic-operator" 
                                    onchange="updateCondition(${cond.id}, 'logicOperator', this.value)">
                                <option value="AND" ${cond.logicOperator === 'AND' ? 'selected' : ''}>AND</option>
                                <option value="OR" ${cond.logicOperator === 'OR' ? 'selected' : ''}>OR</option>
                            </select>
                        </div>
                    `;
                }
                
                // Tr∆∞·ªùng, to√°n t·ª≠, gi√° tr·ªã
                html += `
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm" 
                                   placeholder="Tr∆∞·ªùng (vd: nhiet_do)" 
                                   value="${cond.field}"
                                   onchange="updateCondition(${cond.id}, 'field', this.value)">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm" 
                                    onchange="updateCondition(${cond.id}, 'operator', this.value)">
                                <option value=">" ${cond.operator === '>' ? 'selected' : ''}>&gt;</option>
                                <option value="<" ${cond.operator === '<' ? 'selected' : ''}>&lt;</option>
                                <option value=">=" ${cond.operator === '>=' ? 'selected' : ''}>&gt;=</option>
                                <option value="<=" ${cond.operator === '<=' ? 'selected' : ''}>&lt;=</option>
                                <option value="=" ${cond.operator === '=' ? 'selected' : ''}>=</option>
                                <option value="!=" ${cond.operator === '!=' ? 'selected' : ''}>!=</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control form-control-sm" 
                                   placeholder="Gi√° tr·ªã" 
                                   value="${cond.value}"
                                   onchange="updateCondition(${cond.id}, 'value', this.value)">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeCondition(${cond.id})">
                                üóëÔ∏è X√≥a
                            </button>
                        </div>
                    </div>
                `;
                
                div.innerHTML = html;
                container.appendChild(div);
            });
            
            buildExpression();
        }

        // X√¢y d·ª±ng chu·ªói bi·ªÉu th·ª©c
        function buildExpression() {
            let expr = '';
            
            conditions.forEach((cond, index) => {
                if (index > 0 && cond.logicOperator) {
                    expr += ' ' + cond.logicOperator + ' ';
                }
                
                if (cond.field && cond.value) {
                    expr += `${cond.field} ${cond.operator} ${cond.value}`;
                }
            });
            
            document.getElementById('expressionPreview').textContent = expr || '-';
            document.getElementById('bieuThucLogic').value = expr;
        }

        // Kh√¥ng c√≤n chuy·ªÉn ƒë·ªïi lo·∫°i lu·∫≠t

        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'T·∫°o Lu·∫≠t';
            document.getElementById('ruleForm').reset();
            document.getElementById('ruleId').value = '';
            document.getElementById('expressionSection').style.display = 'block';
            
            // Reset builder
            conditions = [];
            conditionCounter = 0;
            addCondition();
        }

        function editRule(id) {
            fetchWithCSRF(`/api/rules/${id}`).then(r => r.json()).then(rule => {
                document.getElementById('modalTitle').textContent = 'S·ª≠a Lu·∫≠t';
                document.getElementById('ruleId').value = rule.maLuat;
                document.getElementById('expressionSection').style.display = 'block';
                // Parse bi·ªÉu th·ª©c th√†nh c√°c ƒëi·ªÅu ki·ªán (ƒë∆°n gi·∫£n h√≥a): ch·ªâ show to√†n b·ªô expr ƒë·ªÉ ch·ªânh
                conditions = [];
                conditionCounter = 0;
                addCondition();
                document.getElementById('bieuThucLogic').value = rule.bieuThucLogic || '';
                document.getElementById('expressionPreview').textContent = rule.bieuThucLogic || '-';
                document.getElementById('thoiGianDuyTriDieuKien').value = rule.thoiGianDuyTriDieuKien || 0;
                document.getElementById('lenhHanhDong').value = rule.lenhHanhDong || 'hoat_dong';
                document.getElementById('kichHoat').checked = rule.kichHoat;
                new bootstrap.Modal(document.getElementById('ruleModal')).show();
            }).catch(() => alert('L·ªói load'));
        }

        function saveRule() {
            const id = document.getElementById('ruleId').value;
            const lenhHanhDong = document.getElementById('lenhHanhDong').value;
            
            // Validate action
            if (!lenhHanhDong || (lenhHanhDong !== 'hoat_dong' && lenhHanhDong !== 'tat')) {
                return alert('H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá! Ph·∫£i l√† "hoat_dong" ho·∫∑c "tat"');
            }
            
            const data = {
                maThietBi: deviceId,
                lenhHanhDong: lenhHanhDong,
                kichHoat: document.getElementById('kichHoat').checked,
                thoiGianDuyTriDieuKien: parseInt(document.getElementById('thoiGianDuyTriDieuKien').value) || 0
            };
            
            // Ch·ªâ d√πng bi·ªÉu th·ª©c
            const e = document.getElementById('bieuThucLogic').value.trim();
            if (!e) return alert('Nh·∫≠p ƒë·ªß ƒëi·ªÅu ki·ªán!');
            data.bieuThucLogic = e;
            
            console.log('Saving rule with data:', data);
            
            fetchWithCSRF(id ? `/api/rules/${id}` : '/api/rules', {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(r => {
                if (r.ok) {
                    location.reload();
                } else {
                    return r.text().then(text => {
                        console.error('Error response:', text);
                        throw new Error(text);
                    });
                }
            }).catch(err => {
                console.error('Save error:', err);
                alert('L·ªói: ' + (err.message || 'Kh√¥ng th·ªÉ l∆∞u lu·∫≠t'));
            });
        }

        function toggleRule(id, s) {
            if (confirm(`${s ? 'K√≠ch ho·∫°t' : 'T·∫Øt'}?`)) {
                fetchWithCSRF(`/api/rules/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({kichHoat: s})
                }).then(r => r.ok ? location.reload() : Promise.reject()).catch(() => alert('L·ªói!'));
            }
        }

        function deleteRule(id) {
            if (confirm('X√≥a?')) {
                fetchWithCSRF(`/api/rules/${id}`, {method: 'DELETE'})
                    .then(r => r.ok ? location.reload() : Promise.reject()).catch(() => alert('L·ªói!'));
            }
        }
        
        // WebSocket ƒë·ªÉ nh·∫≠n th√¥ng b√°o k√≠ch ho·∫°t t·ª± ƒë·ªông
        let stompClient = null;
        
        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('WebSocket connected: ' + frame);
                
                // Subscribe to device-specific rule activations
                stompClient.subscribe('/topic/device/' + deviceId + '/rule-activation', function(message) {
                    const notification = JSON.parse(message.body);
                    console.log('Rule activated:', notification);
                    showRuleNotification(notification);
                });
            }, function(error) {
                console.error('WebSocket error:', error);
                // Retry connection after 5 seconds
                setTimeout(connectWebSocket, 5000);
            });
        }
        
        function showRuleNotification(notification) {
            // Create a toast notification
            const toast = document.createElement('div');
            toast.className = 'alert alert-info alert-dismissible fade show position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <strong>‚ö° Lu·∫≠t ƒë√£ k√≠ch ho·∫°t!</strong><br>
                ${notification.message || 'ƒêi·ªÅu ki·ªán ƒë√£ th·ªèa m√£n'}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        function disconnectWebSocket() {
            if (stompClient !== null) {
                stompClient.disconnect();
                console.log('WebSocket disconnected');
            }
        }
        
        // Connect WebSocket when page loads
        window.addEventListener('load', function() {
            connectWebSocket();
        });
        
        // Disconnect WebSocket when page unloads
        window.addEventListener('beforeunload', function() {
            disconnectWebSocket();
        });
        
        // ============= VIEW RULE LOGS =============
        const openLogPanels = new Set(); // Track which panels are open
        const logCache = {}; // Cache log data by ruleId
        
        function toggleRuleLogs(button) {
            const ruleId = button.getAttribute('data-rule-id');
            const panel = document.getElementById('logPanel-' + ruleId);
            
            if (panel.style.display === 'none') {
                // Show panel and load logs
                panel.style.display = 'block';
                button.innerHTML = 'üëÅÔ∏è ·∫®n';
                button.classList.remove('btn-info');
                button.classList.add('btn-secondary');
                openLogPanels.add(ruleId);
                loadRuleLogs(ruleId, 0);
            } else {
                // Hide panel
                panel.style.display = 'none';
                button.innerHTML = 'üëÅÔ∏è Log';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-info');
                openLogPanels.delete(ruleId);
            }
        }
        
        function loadRuleLogs(ruleId, page = 0) {
            const tableBody = document.getElementById('logTable-' + ruleId);
            const logCount = document.getElementById('logCount-' + ruleId);
            const loadMoreBtn = document.getElementById('loadMoreBtn-' + ruleId);
            const timeFilter = document.getElementById('timeFilter-' + ruleId).value;
            
            // Show loading
            if (page === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            ƒêang t·∫£i...
                        </td>
                    </tr>
                `;
            }
            
            fetch(`/api/lich-su-canh-bao/luat/${ruleId}?page=${page}&size=20&filter=${timeFilter}`)
                .then(response => response.json())
                .then(data => {
                    // Cache data
                    if (!logCache[ruleId]) logCache[ruleId] = { page: 0, data: [] };
                    if (page === 0) {
                        logCache[ruleId].data = data.content;
                    } else {
                        logCache[ruleId].data.push(...data.content);
                    }
                    logCache[ruleId].page = page;
                    
                    // Update count
                    logCount.textContent = data.totalElements;
                    
                    // Render table
                    if (data.content && data.content.length > 0) {
                        const startIndex = page * 20;
                        tableBody.innerHTML = logCache[ruleId].data.map((log, idx) => {
                            const timeInfo = formatDateTime(log.thoiGian);
                            return `
                                <tr>
                                    <td class="text-muted">${startIndex + idx + 1}</td>
                                    <td>${log.noiDung}</td>
                                    <td class="text-muted">
                                        <div style="line-height: 1.3;">
                                            <strong style="color: #495057;">${timeInfo.relative}</strong>
                                            <br>
                                            <small style="font-size: 0.85em;">${timeInfo.absolute}</small>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                        
                        // Show/hide load more button
                        if (data.totalPages > page + 1) {
                            loadMoreBtn.style.display = 'block';
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="3" class="text-center text-muted py-4">
                                    üì≠ Ch∆∞a c√≥ l·ªãch s·ª≠ c·∫£nh b√°o
                                </td>
                            </tr>
                        `;
                        loadMoreBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center text-danger">
                                ‚ùå Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠: ${error.message}
                            </td>
                        </tr>
                    `;
                });
        }
        
        function loadMoreLogs(ruleId) {
            const currentPage = logCache[ruleId]?.page || 0;
            loadRuleLogs(ruleId, currentPage + 1);
        }
        
        function refreshLogs(ruleId) {
            delete logCache[ruleId];
            loadRuleLogs(ruleId, 0);
        }
        
        function filterLogs(selectElement) {
            const ruleId = selectElement.id.replace('timeFilter-', '');
            delete logCache[ruleId];
            loadRuleLogs(ruleId, 0);
        }
        
        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            const absoluteTime = date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let relativeTime;
            if (diffMins < 1) {
                relativeTime = 'V·ª´a xong';
            } else if (diffMins < 60) {
                relativeTime = `${diffMins} ph√∫t tr∆∞·ªõc`;
            } else if (diffHours < 24) {
                relativeTime = `${diffHours} gi·ªù tr∆∞·ªõc`;
            } else if (diffDays < 7) {
                relativeTime = `${diffDays} ng√†y tr∆∞·ªõc`;
            } else {
                relativeTime = absoluteTime;
            }
            
            return {
                relative: relativeTime,
                absolute: absoluteTime
            };
        }
    </script>
</body>
</html>
